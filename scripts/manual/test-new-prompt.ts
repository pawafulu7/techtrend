#!/usr/bin/env tsx
import fetch from 'node-fetch';

async function testNewPrompt() {
  console.error('ğŸ§ª æ–°ã—ã„ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šã®ãƒ†ã‚¹ãƒˆ\n');
  console.error('å‰æ: LLMã‚µãƒ¼ãƒãƒ¼å´ã«ä»¥ä¸‹ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’æƒ³å®š\n');
  console.error('=' * 60);
  
  const url = 'http://192.168.11.7:1234';
  const model = 'openai/gpt-oss-20b';
  
  const testArticle = {
    title: 'GraphQLã¨RESTã®ä½¿ã„åˆ†ã‘: ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ç’°å¢ƒã§ã®æœ€é©ãªé¸æŠ',
    content: `
è¿‘å¹´ã€APIè¨­è¨ˆã«ãŠã„ã¦GraphQLã¨RESTã¨ã„ã†2ã¤ã®ä¸»è¦ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒå­˜åœ¨ã—ã¾ã™ã€‚
æœ¬è¨˜äº‹ã§ã¯ã€ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ç’°å¢ƒã«ãŠã„ã¦ã€ã©ã®ã‚ˆã†ãªå ´é¢ã§GraphQLã‚’é¸æŠã—ã€
ã©ã®ã‚ˆã†ãªå ´é¢ã§RESTã‚’é¸æŠã™ã¹ãã‹ã‚’å®Ÿè·µçš„ãªè¦³ç‚¹ã‹ã‚‰è§£èª¬ã—ã¾ã™ã€‚

## GraphQLã®åˆ©ç‚¹

GraphQLã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒå¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’æ­£ç¢ºã«æŒ‡å®šã§ãã‚‹ã‚¯ã‚¨ãƒªè¨€èªã§ã™ã€‚
å˜ä¸€ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰è¤‡æ•°ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’åŠ¹ç‡çš„ã«å–å¾—ã§ãã€
ã‚ªãƒ¼ãƒãƒ¼ãƒ•ã‚§ãƒƒãƒãƒ³ã‚°ã‚„ã‚¢ãƒ³ãƒ€ãƒ¼ãƒ•ã‚§ãƒƒãƒãƒ³ã‚°ã®å•é¡Œã‚’è§£æ±ºã—ã¾ã™ã€‚

ç‰¹ã«ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚„SPAã§ã¯ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¾€å¾©å›æ•°ã‚’å‰Šæ¸›ã§ãã‚‹ãŸã‚ã€
ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å‘ä¸ŠãŒæœŸå¾…ã§ãã¾ã™ã€‚ã¾ãŸã€å‹ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹
è‡ªå·±æ–‡æ›¸åŒ–æ©Ÿèƒ½ã«ã‚ˆã‚Šã€é–‹ç™ºåŠ¹ç‡ã‚‚å‘ä¸Šã—ã¾ã™ã€‚

## RESTã®åˆ©ç‚¹

RESTã¯ã€HTTPã®æ¨™æº–çš„ãªãƒ¡ã‚½ãƒƒãƒ‰ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æ´»ç”¨ã—ãŸ
ã‚·ãƒ³ãƒ—ãƒ«ã§ç›´æ„Ÿçš„ãªAPIè¨­è¨ˆæ‰‹æ³•ã§ã™ã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å®Ÿè£…ãŒå®¹æ˜“ã§ã€
CDNã¨ã®è¦ªå’Œæ€§ã‚‚é«˜ãã€å¤§è¦æ¨¡ãªãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã«å¯¾å¿œã—ã‚„ã™ã„ã¨ã„ã†ç‰¹å¾´ãŒã‚ã‚Šã¾ã™ã€‚

ã¾ãŸã€ãƒ„ãƒ¼ãƒ«ã‚„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ãŒæˆç†Ÿã—ã¦ãŠã‚Šã€
é–‹ç™ºè€…ã®å­¦ç¿’ã‚³ã‚¹ãƒˆã‚‚æ¯”è¼ƒçš„ä½ã„ã¨ã„ã†åˆ©ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚

## ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ç’°å¢ƒã§ã®ä½¿ã„åˆ†ã‘

### GraphQLãŒé©ã—ã¦ã„ã‚‹å ´é¢

1. **BFFï¼ˆBackend for Frontendï¼‰ãƒ‘ã‚¿ãƒ¼ãƒ³**
   è¤‡æ•°ã®ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’é›†ç´„ã—ã¦ã€
   ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å‘ã‘ã«æœ€é©åŒ–ã•ã‚ŒãŸAPIã‚’æä¾›ã™ã‚‹å ´åˆ

2. **è¤‡é›‘ãªãƒ‡ãƒ¼ã‚¿é–¢ä¿‚**
   é–¢é€£ã™ã‚‹è¤‡æ•°ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä¸€åº¦ã«å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆ

3. **ãƒ¢ãƒã‚¤ãƒ«ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ**
   å¸¯åŸŸå¹…ãŒé™ã‚‰ã‚ŒãŸç’°å¢ƒã§ã€å¿…è¦æœ€å°é™ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’å–å¾—ã—ãŸã„å ´åˆ

### RESTãŒé©ã—ã¦ã„ã‚‹å ´é¢

1. **å…¬é–‹API**
   å¤–éƒ¨é–‹ç™ºè€…å‘ã‘ã®APIã§ã€ã‚·ãƒ³ãƒ—ãƒ«ã§ç†è§£ã—ã‚„ã™ã„ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒå¿…è¦ãªå ´åˆ

2. **ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰/ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**
   ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ã‚„å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ã®è»¢é€ãŒå¿…è¦ãªå ´åˆ

3. **ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹é–“é€šä¿¡**
   ã‚µãƒ¼ãƒ“ã‚¹é–“ã®å†…éƒ¨é€šä¿¡ã§ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚„HTTPã‚»ãƒãƒ³ãƒ†ã‚£ã‚¯ã‚¹ã‚’æ´»ç”¨ã—ãŸã„å ´åˆ

## ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€GraphQLã¨RESTã‚’çµ„ã¿åˆã‚ã›ãŸãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒ
åŠ¹æœçš„ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€ãƒ¡ã‚¤ãƒ³ã®APIã¯GraphQLã§æ§‹ç¯‰ã—ã€
ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚„èªè¨¼ãªã©ã®ç‰¹å®šã®æ©Ÿèƒ½ã¯RESTã§å®Ÿè£…ã™ã‚‹ã¨ã„ã†æ–¹æ³•ã§ã™ã€‚

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ

å®Ÿéš›ã®æ¸¬å®šçµæœã§ã¯ï¼š
- GraphQL: è¤‡æ•°ãƒªã‚½ãƒ¼ã‚¹å–å¾—æ™‚ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¾€å¾©ã‚’70%å‰Šæ¸›
- REST: å˜ä¸€ãƒªã‚½ãƒ¼ã‚¹å–å¾—æ™‚ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ãŒ20%é«˜é€Ÿ
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ç‡: RESTãŒ40%å„ªã‚Œã¦ã„ã‚‹

## ã¾ã¨ã‚

GraphQLã¨RESTã®é¸æŠã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¦ä»¶ã€ãƒãƒ¼ãƒ ã®ã‚¹ã‚­ãƒ«ã‚»ãƒƒãƒˆã€
æ—¢å­˜ã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ãªã©ã€å¤šãã®è¦å› ã‚’è€ƒæ…®ã—ã¦æ±ºå®šã™ã¹ãã§ã™ã€‚
é‡è¦ãªã®ã¯ã€ãã‚Œãã‚Œã®ç‰¹æ€§ã‚’ç†è§£ã—ã€é©åˆ‡ãªå ´é¢ã§é©åˆ‡ãªæŠ€è¡“ã‚’é¸æŠã™ã‚‹ã“ã¨ã§ã™ã€‚
    `.trim()
  };

  // ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: è¦ç´„ã¨ã‚¿ã‚°ç”Ÿæˆ
  console.error('ğŸ“ ãƒ†ã‚¹ãƒˆ1: è¦ç´„ã¨ã‚¿ã‚°ç”Ÿæˆï¼ˆæ¨™æº–å½¢å¼ï¼‰');
  console.error('-'.repeat(60));
  
  try {
    const prompt1 = `ä»¥ä¸‹ã®æŠ€è¡“è¨˜äº‹ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚

ã‚¿ã‚¤ãƒˆãƒ«: ${testArticle.title}
å†…å®¹: ${testArticle.content.substring(0, 2000)}

å‡ºåŠ›å½¢å¼:
è¦ç´„: [60-80æ–‡å­—ã®æ—¥æœ¬èªã§ç°¡æ½”ã«ã¾ã¨ã‚ã‚‹]
ã‚¿ã‚°: [3-5å€‹ã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š]`;

    const response1 = await fetch(`${url}/v1/chat/completions`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model,
        messages: [{ role: 'user', content: prompt1 }],
        max_tokens: 500,
        temperature: 0.3,
      }),
    });

    if (response1.ok) {
      const data = await response1.json() as any;
      const output = data.choices?.[0]?.message?.content || '';
      
      console.error('å‡ºåŠ›:');
      console.error(output);
      
      // å“è³ªãƒã‚§ãƒƒã‚¯
      const lines = output.split('\n');
      const summaryLine = lines.find((l: string) => l.startsWith('è¦ç´„:'));
      const tagsLine = lines.find((l: string) => l.startsWith('ã‚¿ã‚°:'));
      
      if (summaryLine) {
        const summary = summaryLine.replace('è¦ç´„:', '').trim();
        console.error('\nâœ… è¦ç´„ãƒã‚§ãƒƒã‚¯:');
        console.error(`  æ–‡å­—æ•°: ${summary.length}æ–‡å­— ${summary.length >= 60 && summary.length <= 80 ? 'âœ…' : 'âŒ'}`);
        console.error(`  å¥ç‚¹çµ‚äº†: ${summary.endsWith('ã€‚') ? 'âœ…' : 'âŒ'}`);
        console.error(`  è‹±èªæ··å…¥ãªã—: ${!/need|let's|count/i.test(summary) ? 'âœ…' : 'âŒ'}`);
      }
      
      if (tagsLine) {
        const tags = tagsLine.replace('ã‚¿ã‚°:', '').trim().split(/[,ã€]/);
        console.error('\nâœ… ã‚¿ã‚°ãƒã‚§ãƒƒã‚¯:');
        console.error(`  ã‚¿ã‚°æ•°: ${tags.length}å€‹ ${tags.length >= 3 && tags.length <= 5 ? 'âœ…' : 'âŒ'}`);
        console.error(`  ã‚¿ã‚°: ${tags.map(t => t.trim()).join(', ')}`);
      }
    }
  } catch (error) {
    console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error);
  }

  // å°‘ã—å¾…æ©Ÿ
  await new Promise(resolve => setTimeout(resolve, 2000));

  // ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: è©³ç´°è¦ç´„ç”Ÿæˆ
  console.error('\n\nğŸ“ ãƒ†ã‚¹ãƒˆ2: è©³ç´°è¦ç´„ç”Ÿæˆï¼ˆç®‡æ¡æ›¸ãå½¢å¼ï¼‰');
  console.error('-'.repeat(60));
  
  try {
    const prompt2 = `ä»¥ä¸‹ã®æŠ€è¡“è¨˜äº‹ã‚’è©³ç´°ã«åˆ†æã—ã¦ãã ã•ã„ã€‚

ã‚¿ã‚¤ãƒˆãƒ«: ${testArticle.title}
å†…å®¹: ${testArticle.content}

ä»¥ä¸‹ã®å½¢å¼ã§ç®‡æ¡æ›¸ãã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
ãƒ»è¨˜äº‹ã®ä¸»é¡Œã¯ã€[å†…å®¹]
ãƒ»è§£æ±ºã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹å•é¡Œã¯ã€[å†…å®¹]
ãƒ»æç¤ºã•ã‚Œã¦ã„ã‚‹è§£æ±ºç­–ã¯ã€[å†…å®¹]
ãƒ»å®Ÿè£…æ–¹æ³•ã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€[å†…å®¹]
ãƒ»æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœã¯ã€[å†…å®¹]
ãƒ»å®Ÿè£…æ™‚ã®æ³¨æ„ç‚¹ã¯ã€[å†…å®¹]

å„é …ç›®ã¯50-150æ–‡å­—ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚`;

    const response2 = await fetch(`${url}/v1/chat/completions`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model,
        messages: [{ role: 'user', content: prompt2 }],
        max_tokens: 1000,
        temperature: 0.3,
      }),
    });

    if (response2.ok) {
      const data = await response2.json() as any;
      const output = data.choices?.[0]?.message?.content || '';
      
      console.error('å‡ºåŠ›:');
      console.error(output);
      
      // å“è³ªãƒã‚§ãƒƒã‚¯
      const bulletPoints = output.split('\n').filter(line => line.trim().startsWith('ãƒ»'));
      
      console.error('\nâœ… è©³ç´°è¦ç´„ãƒã‚§ãƒƒã‚¯:');
      console.error(`  é …ç›®æ•°: ${bulletPoints.length}å€‹ ${bulletPoints.length === 6 ? 'âœ…' : 'âš ï¸'}`);
      
      const requiredKeywords = [
        'è¨˜äº‹ã®ä¸»é¡Œ',
        'è§£æ±ºã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹å•é¡Œ',
        'æç¤ºã•ã‚Œã¦ã„ã‚‹è§£æ±ºç­–',
        'å®Ÿè£…æ–¹æ³•',
        'æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ',
        'å®Ÿè£…æ™‚ã®æ³¨æ„ç‚¹'
      ];
      
      requiredKeywords.forEach(keyword => {
        const hasKeyword = bulletPoints.some(line => line.includes(keyword));
        console.error(`  ã€Œ${keyword}ã€: ${hasKeyword ? 'âœ…' : 'âŒ'}`);
      });
      
      // è‹±èªã®æ··å…¥ãƒã‚§ãƒƒã‚¯
      const hasEnglishThinking = /need|let's|count|craft/i.test(output);
      console.error(`  è‹±èªæ€è€ƒéç¨‹ãªã—: ${!hasEnglishThinking ? 'âœ…' : 'âŒ'}`);
    }
  } catch (error) {
    console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error);
  }

  console.error('\n' + '=' * 60);
  console.error('ğŸ“Š ãƒ†ã‚¹ãƒˆå®Œäº†');
  console.error('=' * 60);
  console.error('\næ¨å¥¨äº‹é …:');
  console.error('1. ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª');
  console.error('2. è‹±èªã®æ€è€ƒéç¨‹ãŒå‡ºåŠ›ã•ã‚Œã‚‹å ´åˆã¯ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å¼·åŒ–');
  console.error('3. é …ç›®ãŒä¸è¶³ã™ã‚‹å ´åˆã¯ã€max_tokensã‚’å¢—ã‚„ã™');
  console.error('4. å½¢å¼ãŒå´©ã‚Œã‚‹å ´åˆã¯ã€temperatureã‚’ä¸‹ã’ã‚‹ï¼ˆ0.2-0.3æ¨å¥¨ï¼‰');
}

testNewPrompt().catch(console.error);