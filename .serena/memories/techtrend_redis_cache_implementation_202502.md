# TechTrend Redisキャッシュ実装詳細（2025年2月）

## 概要
TechTrendでは、パフォーマンス向上とN+1問題対策のため、包括的なRedisキャッシュシステムを実装しています。

## キャッシュアーキテクチャ

### 1. 基本キャッシュ層（lib/cache/redis-cache.ts）
**RedisCache クラス**
- 名前空間ベースのキー管理
- TTL自動設定（デフォルト: 1時間）
- 統計情報収集（ヒット率、ミス数）
- パターンベースの無効化機能

主要メソッド:
- `get/set`: 基本的なキャッシュ操作
- `getOrSet`: キャッシュミス時の自動取得・設定
- `invalidatePattern`: パターンマッチによる一括削除
- `getStats/resetStats`: 統計情報管理

### 2. 分散ロック機能（lib/cache/redis-cache-with-lock.ts）
**RedisCacheWithLock クラス**
- キャッシュスタンピード防止
- 分散環境での排他制御
- マルチキー同時処理対応

特徴:
- ロックTTL: 30秒（デフォルト）
- スタンピード防止モード搭載
- ロック状態の可視化

### 3. フォールバック機能（lib/cache/redis-cache-with-fallback.ts）
**RedisCacheWithFallback クラス**
- Redis障害時のメモリキャッシュフォールバック
- 自動クリーンアップ機能
- メモリ使用量監視

メモリキャッシュ仕様:
- 最大エントリ数: 1000
- TTL: 5分
- 自動クリーンアップ間隔: 1分

### 4. サーキットブレーカー（lib/cache/circuit-breaker.ts）
**CircuitBreaker クラス**
- 障害検出と自動遮断
- 段階的な復旧試行
- エラー率ベースの状態遷移

状態:
- CLOSED: 正常動作
- OPEN: 遮断中（エラー率50%超）
- HALF_OPEN: 復旧試行中

### 5. メモリ最適化（lib/cache/memory-optimizer.ts）
**MemoryOptimizer クラス**
- Redis メモリ使用量監視
- 自動最適化実行
- 段階的なキャッシュクリア

最適化戦略:
1. TTL短縮（通常時の50%）
2. 期限切れキーの削除
3. 古いキーの強制削除
4. 低優先度キャッシュのクリア
5. 緊急時の全キャッシュクリア

閾値:
- 警告: メモリ使用率80%
- 緊急: メモリ使用率90%

### 6. キャッシュウォーマー（lib/cache/cache-warmer.ts）
**CacheWarmer クラス**
- 事前キャッシュ生成
- バッチ処理対応
- 進捗追跡機能

ウォームアップ対象:
- 人気記事TOP100
- タグクラウドデータ
- ソース統計情報
- トレンド分析データ

### 7. キャッシュ無効化（lib/cache/cache-invalidator.ts）
**CacheInvalidator クラス**
- 依存関係ベースの無効化
- カスケード削除
- 選択的無効化

無効化ルール:
- 記事更新時: 関連タグ、ソース、統計をクリア
- タグ更新時: タグクラウド、関連記事をクリア
- ソース更新時: ソース別記事リストをクリア

## 専門キャッシュ実装

### 記事検索キャッシュ（search-cache.ts）
- 検索条件のハッシュ化
- TTL: 30分
- 最大100件の結果保持

### トレンドキャッシュ（trends-cache.ts）
- キーワード分析結果
- TTL: 1時間
- 日別・週別・月別の集計

### 人気記事キャッシュ（popular-cache.ts）
- TOP記事リスト
- TTL: 15分
- ソース別・全体ランキング

### タグキャッシュ（tag-cache.ts）
- タグクラウドデータ
- TTL: 2時間
- カテゴリ別集計

### ソースキャッシュ（source-cache.ts）
- ソース別記事リスト
- TTL: 30分
- 有効ソースのみキャッシュ

### 統計キャッシュ（stats-cache.ts）
- 各種統計情報
- TTL: 1時間
- 日次・週次・月次集計

## キャッシュキー命名規則
```
{namespace}:{entity}:{identifier}:{params_hash}

例:
- articles:list:page1:hash123
- articles:detail:article_id_abc
- tags:cloud:all
- stats:daily:2025-02-06
- trends:keywords:week:hash456
```

## パフォーマンス最適化

### N+1問題対策
1. **バッチ取得**: 複数IDを一括取得
2. **分散ロック**: 同時リクエストの重複処理防止
3. **プリロード**: 関連データの事前取得

### メモリ効率化
1. **適切なTTL設定**: データ特性に応じた有効期限
2. **選択的キャッシング**: 高頻度アクセスデータのみ
3. **圧縮**: 大きなデータはgzip圧縮

### 可用性向上
1. **フォールバック**: Redis障害時のメモリキャッシュ
2. **サーキットブレーカー**: 連続エラー時の自動遮断
3. **グレースフルデグレード**: 部分的な機能縮退

## 監視・運用

### ヘルスチェック（/api/cache/health）
- Redis接続状態
- メモリ使用量
- キャッシュヒット率
- エラー率

### 統計情報（/api/cache/stats）
- 名前空間別の統計
- ヒット/ミス数
- 平均レスポンス時間
- メモリ使用量

### 最適化API（/api/cache/optimize）
- 手動最適化実行
- キャッシュクリア
- 統計リセット

## ベストプラクティス
1. **適切な粒度**: キャッシュ単位は小さく保つ
2. **無効化戦略**: 更新時は関連キャッシュも無効化
3. **TTL設計**: データの更新頻度に応じて設定
4. **エラーハンドリング**: キャッシュミスでも正常動作
5. **モニタリング**: 定期的な統計確認と調整