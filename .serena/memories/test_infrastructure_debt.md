# テストインフラの技術的負債

## 現状の問題点

### 1. テストカバレッジの極端な低さ
- Jest設定でカバレッジ閾値が全て5%に設定
- 実質的にテストが書かれていない状態
- テストファイルは存在するが実装が不十分

### 2. テストファイルの配置
- `__tests__/` と `tests/` の2つのディレクトリが混在
- 統一されていないテスト配置戦略

### 3. 重要機能のテスト不足
未テストの重要機能：
- 記事収集フェッチャー（60以上のスクリプト）
- 要約生成処理
- 品質スコア計算ロジック
- スケジューラー処理
- データベース操作

### 4. E2Eテストの未実装
- Playwrightの設定なし
- ユーザーフローのテストが皆無

## 段階的改善計画

### フェーズ1: 基礎固め（1-2週間）
**目標カバレッジ: 20%**
1. 品質スコア計算のユニットテスト
2. タグ正規化のユニットテスト
3. 要約パーサーのユニットテスト
4. 重複検出ロジックのテスト

### フェーズ2: API層のテスト（2-3週間）
**目標カバレッジ: 40%**
1. フェッチャーのモックテスト
2. APIエンドポイントの統合テスト
3. エラーハンドリングのテスト
4. レート制限のテスト

### フェーズ3: UI層のテスト（3-4週間）
**目標カバレッジ: 60%**
1. React Componentのテスト
2. カスタムフックのテスト
3. フォーム操作のテスト
4. 状態管理のテスト

### フェーズ4: E2Eテスト（2週間）
1. Playwright導入
2. 主要ユーザーフローのテスト
3. クロスブラウザテスト
4. パフォーマンステスト

## 推奨ツール・ライブラリ

### ユニットテスト
- Jest（既存）
- React Testing Library（既存）
- MSW（Mock Service Worker）- API モック用

### E2Eテスト
- Playwright
- Cypress（代替案）

### テストユーティリティ
- faker.js - テストデータ生成
- fishery - ファクトリパターンでのテストデータ作成

## 即効性のある改善策

1. **カバレッジ目標の現実的な設定**
   ```javascript
   // jest.config.js
   coverageThreshold: {
     global: {
       branches: 20,    // 5% → 20%
       functions: 20,   // 5% → 20%
       lines: 20,       // 5% → 20%
       statements: 20,  // 5% → 20%
     },
   }
   ```

2. **pre-commitフックでのテスト実行**
   - huskyの導入
   - 変更されたファイルのテスト自動実行

3. **テスト作成のルール化**
   - 新規機能にはテスト必須
   - バグ修正時は再現テストを追加
   - PRレビューでテストの有無を確認

4. **テストデータの整備**
   - Prismaのシードデータ活用
   - テスト用フィクスチャの作成

## 費用対効果の高い最初の一歩

1. `lib/utils/quality-score.ts` のテスト作成（1日）
2. `lib/utils/tag-normalizer.ts` のテスト作成（0.5日）
3. カバレッジレポートのCI統合（0.5日）

これらを実施するだけで、開発者の意識が変わり、テスト文化の醸成につながる。