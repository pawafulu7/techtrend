# スクリプト統合・機能一致化実装計画

## 計画日時
2025-08-01 11:45:00

## 背景
調査結果により、要約生成関連スクリプト間で機能の不一致が発見された。特にregenerateSummaries.tsでタグ生成機能が欠落しており、既存記事の要約を再生成する際にタグが失われるリスクがある。

## 目的
1. regenerateSummaries.tsにタグ生成機能を追加
2. タグ正規化マップを共通化してメンテナンス性を向上
3. スクリプト間の機能差異を解消

## 実装方針

### フェーズ1: タグ正規化の共通化（優先度：高）
**目的**: 重複コードを排除し、メンテナンス性を向上

#### 1-1. タグ正規化ユーティリティの作成
- ファイル: `/lib/utils/tag-normalizer.ts`
- 内容:
  - タグ正規化マップの定義
  - normalizeTag関数のエクスポート
  - タグ検証機能（オプション）

### フェーズ2: regenerateSummaries.tsの機能拡張（優先度：高）
**目的**: タグ生成機能を追加し、機能の一貫性を確保

#### 2-1. タグ生成機能の統合
- generateNewSummaries関数の拡張
- タグ生成プロンプトの追加
- レスポンスパース処理の更新

#### 2-2. タグ保存処理の実装
- 既存タグの確認
- 新規タグの作成
- 記事へのタグ関連付け

### フェーズ3: generate-summaries.tsのリファクタリング（優先度：中）
**目的**: 共通化されたユーティリティを使用

#### 3-1. タグ正規化処理の置き換え
- tag-normalizerのインポート
- ローカル定義の削除

### フェーズ4: generate-tags-only.tsのリファクタリング（優先度：中）
**目的**: 共通化されたユーティリティを使用

#### 4-1. タグ正規化処理の置き換え
- tag-normalizerのインポート
- ローカル定義の削除

## 詳細実装タスク

### タスク1: タグ正規化ユーティリティ作成
**ファイル**: `/lib/utils/tag-normalizer.ts`
```typescript
// タグ正規化マップ
export const TAG_NORMALIZATION_MAP: Record<string, string> = {
  // 既存のマッピングをここに移動
};

// タグ正規化関数
export function normalizeTag(tag: string): string {
  // 実装
}

// タグ検証関数（オプション）
export function isValidTag(tag: string): boolean {
  // 実装
}
```

### タスク2: regenerateSummaries.ts修正
1. **プロンプト修正**
   - タグ生成指示の追加
   - 回答形式にタグセクションを追加

2. **パース処理の更新**
   - parseSummary関数をparseSummaryAndTagsに変更
   - タグ抽出ロジックの追加

3. **データベース更新処理**
   - タグの保存処理追加
   - トランザクション処理の検討

### タスク3: 各スクリプトのリファクタリング
- generate-summaries.ts
- generate-tags-only.ts
- 共通インポートの追加

## ファイル変更計画

### 新規作成
1. `/lib/utils/tag-normalizer.ts` - タグ正規化ユーティリティ

### 修正
1. `/scripts/regenerateSummaries.ts` - タグ生成機能追加
2. `/scripts/generate-summaries.ts` - タグ正規化処理の置き換え
3. `/scripts/generate-tags-only.ts` - タグ正規化処理の置き換え

### 削除
- なし

## テスト戦略

### 単体テスト
1. tag-normalizerのテスト
   - 正規化処理の動作確認
   - エッジケースのテスト

### 統合テスト
1. regenerateSummaries.tsのタグ生成テスト
   - ドライランモードでの動作確認
   - 実際のデータでの検証

### 手動テスト
1. 各スクリプトの動作確認
2. タグの一貫性確認

## リスク分析と対策

### リスク1: 既存タグの上書き
- **対策**: 既存タグの確認処理を必ず実装
- **実装**: タグの差分更新ロジック

### リスク2: API制限によるエラー
- **対策**: リトライ機能の実装
- **実装**: generate-summaries.tsの実装を参考

### リスク3: パフォーマンスの低下
- **対策**: バッチ処理の最適化
- **実装**: 適切な待機時間の設定

## スケジュール見積もり

1. タグ正規化ユーティリティ作成: 30分
2. regenerateSummaries.ts修正: 2時間
3. 各スクリプトのリファクタリング: 1時間
4. テスト・検証: 1時間

**合計: 約4.5時間**

## 実装の優先順位

1. タグ正規化ユーティリティの作成（基盤となるため）
2. regenerateSummaries.tsへのタグ生成機能追加（最重要）
3. generate-summaries.tsのリファクタリング
4. generate-tags-only.tsのリファクタリング
5. テストと検証

## 成功基準

1. regenerateSummaries.tsで要約とタグが同時に生成される
2. すべてのスクリプトで同じタグ正規化ロジックを使用
3. 既存のタグが失われない
4. エラーハンドリングが適切に実装されている

## 次のステップ

1. 実装開始の承認を得る
2. タグ正規化ユーティリティから順次実装
3. 各スクリプトの修正
4. 統合テストの実施
5. 本番環境での動作確認