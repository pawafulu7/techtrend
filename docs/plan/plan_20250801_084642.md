# タグ設定問題の実装計画

## 計画作成日時
2025-08-01 08:46:42

## 概要
TechTrendプロジェクトにおいて、405記事すべてにタグが設定されていない問題を解決するための実装計画。

## 調査結果サマリー
- **問題**: 405記事中0記事にタグが設定されていない
- **原因1**: regenerateSummaries.tsにタグ生成機能が未実装
- **原因2**: generate-summaries.tsが既存要約がある場合のタグ生成を適切に処理していない
- **影響**: タグによる検索・フィルタリング機能が使用不可

## 実装方針

### Phase 1: 緊急対応（即日実行）
最小限のリスクで既存記事にタグを設定する。

### Phase 2: システム改善（1-2日以内）
再発防止のためのシステム改善を実施する。

## 詳細実装タスク

### 優先度: 最高
**1. generate-tags-only.ts の新規作成**
- 目的: 既存記事のタグのみを生成する専用スクリプト
- 理由: 要約を変更せず、タグのみを追加する最も安全な方法
- 実装内容:
  ```typescript
  // 主要機能
  - Gemini APIを使用したタグ生成
  - 既存のタグ正規化ロジックの利用
  - バッチ処理（10記事ずつ）
  - API制限対策（3秒待機）
  - 進捗表示とエラーハンドリング
  - ドライランモード
  ```

### 優先度: 高
**2. regenerateSummaries.ts の修正**
- 目的: 今後の要約再生成時にタグも同時に生成
- 実装内容:
  ```typescript
  // 追加する機能
  - タグ生成をプロンプトに追加
  - parseSummaryAndTags関数の実装
  - タグ保存処理の追加
  - 既存タグとの重複チェック
  ```

### 優先度: 中
**3. check-tag-quality.ts の作成**
- 目的: タグの品質と設定状況の監視
- 実装内容:
  ```typescript
  // チェック項目
  - タグ設定率の確認
  - タグの分布と使用頻度
  - 人気タグのランキング
  - タグなし記事の検出
  - 異常なタグの検出
  ```

### 優先度: 低（Phase 2）
**4. generate-summaries.ts の改善**
- 目的: 既存要約がある場合でもタグがなければ生成
- 実装内容:
  ```typescript
  // 改善点
  - タグの有無を個別にチェック
  - タグのみの生成モード追加
  - より効率的な処理フロー
  ```

## ファイル変更計画

### 新規作成
1. `/home/tomoaki/work/techtrend/scripts/generate-tags-only.ts`
   - 既存記事専用のタグ生成スクリプト
   - 約200行程度

2. `/home/tomoaki/work/techtrend/scripts/check-tag-quality.ts`
   - タグ品質チェックスクリプト
   - 約150行程度

### 修正
1. `/home/tomoaki/work/techtrend/scripts/regenerateSummaries.ts`
   - タグ生成機能の追加
   - 約100行の追加

### 将来的な修正
1. `/home/tomoaki/work/techtrend/scripts/generate-summaries.ts`
   - ロジックの改善
   - 約50行の修正

## テスト戦略

### 1. 単体テスト
- タグ生成関数の正常系・異常系テスト
- タグ正規化関数のテスト
- データベース操作のモックテスト

### 2. 統合テスト
- 少数の記事（5-10件）でタグ生成を実行
- データベースへの保存確認
- 重複タグの処理確認
- タグと記事の関連付け確認

### 3. 手動確認
- 生成されたタグの質をサンプルチェック（20-30記事）
- UIでのタグ表示確認
- タグによるフィルタリング動作確認

### 4. 性能テスト
- 全記事（405件）での処理時間測定
- API制限への対応確認
- データベース負荷の確認

## リスク分析と対策

### リスク1: Gemini API制限
- **影響**: 処理の中断、エラー発生
- **対策**: 
  - バッチサイズを10記事に制限
  - 各バッチ間で3-5秒の待機
  - リトライ機能（最大3回）
  - 503エラー時は待機時間を延長

### リスク2: 不適切なタグ生成
- **影響**: 検索・フィルタリング精度の低下
- **対策**:
  - タグ正規化の強化
  - 最大タグ数を5-7個に制限
  - 一般的すぎるタグの除外
  - 手動での品質チェック

### リスク3: データベース負荷
- **影響**: サービスのパフォーマンス低下
- **対策**:
  - トランザクション処理の実装
  - バッチ単位での処理
  - オフピーク時間での実行

### リスク4: 既存データの破損
- **影響**: 要約やその他のデータの損失
- **対策**:
  - タグのみを更新（要約は変更しない）
  - ドライランモードでの事前確認
  - データベースバックアップの確認

## 実行計画

### Day 1（即日）
1. generate-tags-only.ts の実装（2時間）
2. ドライランでのテスト（30分）
3. 小規模バッチでの実行（30分）
4. 全記事への適用（2-3時間）
5. 結果確認とUIテスト（30分）

### Day 2
1. regenerateSummaries.ts の修正（1時間）
2. check-tag-quality.ts の実装（1時間）
3. 統合テストの実施（1時間）

### Day 3-5（Phase 2）
1. generate-summaries.ts の改善検討
2. 長期的な監視体制の構築

## 成功基準
1. 全405記事にタグが設定されること
2. 各記事に3-7個の適切なタグが付与されること
3. UIでタグによる検索・フィルタリングが機能すること
4. 新規記事取得時にタグが自動生成されること

## 次のステップ
1. generate-tags-only.ts の実装を開始
2. 実装完了後、ドライランモードでテスト
3. 問題がなければ全記事に適用

---
計画作成者: Claude Code
計画バージョン: 1.0